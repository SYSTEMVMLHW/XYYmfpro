<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>购物车</title>
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            color: #202124;
            background: #fff;
        }

        .cart-container { display: flex; flex-direction: column; height: 100%; }
        .cart-header { padding: 12px 16px; border-bottom: 1px solid #e8eaed; }
        .cart-title { margin: 0; font-size: 16px; font-weight: 600; }
        .cart-content { flex: 1; overflow: auto; padding: 12px 12px 80px 12px; }
        .notice { padding: 10px 12px; border-radius: 8px; background: #f8f9fa; color: #5f6368; font-size: 12px; margin: 12px; display: none; }

        .card { background: #fff; border: 1px solid #e8eaed; border-radius: 12px; padding: 12px; margin: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
        .card-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px; }
        .btn { border: none; padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .btn-danger { background: #d93025; color: #fff; }
        .btn-danger:hover { background: #b3261e; }
        .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .row + .row { margin-top: 6px; }
        .label { color: #5f6368; font-size: 12px; min-width: 72px; }
        .value { font-size: 14px; }
        .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
        .badge { display: inline-block; padding: 2px 6px; border-radius: 999px; font-size: 12px; background: #e8f0fe; color: #1967d2; }
        .config-box { background: #f8f9fa; border: 1px dashed #e8eaed; border-radius: 8px; padding: 8px; font-size: 12px; color: #3c4043; max-height: 160px; overflow: auto; white-space: pre-wrap; }

        .summary { position: sticky; bottom: 0; background: #fff; border-top: 1px solid #e8eaed; padding: 12px 16px; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; font-size: 14px; }
        .summary-row.total { font-weight: 700; font-size: 16px; }

        .checkout { display: flex; justify-content: flex-end; margin-top: 8px; }
        .checkout-btn {
            background: #1a73e8;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        .checkout-btn:hover { background: #1557b0; }
		.checkout-btn:disabled { background: #dadce0; color: #9aa0a6; cursor: not-allowed; }

        .loading { display: flex; align-items: center; justify-content: center; padding: 24px; color: #5f6368; gap: 8px; }
        .spinner { width: 16px; height: 16px; border: 2px solid #e8eaed; border-top-color: #1a73e8; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg) } }
    </style>
    <script>
        const API_URL = 'https://app2.ceshi.cs/cart/get_shop_data';

        function $(id){ return document.getElementById(id); }

        function showStatus(msg, tone){
            const bar = $('statusBar');
            bar.style.display = 'block';
            bar.textContent = msg || '';
            if (tone === 'error') { bar.style.background = '#fce8e6'; bar.style.color = '#c5221f'; }
            else if (tone === 'success') { bar.style.background = '#e6f4ea'; bar.style.color = '#188038'; }
            else { bar.style.background = '#f8f9fa'; bar.style.color = '#5f6368'; }
        }

        function parseMaybeJson(val){
            if (typeof val !== 'string') return val;
            try { return JSON.parse(val); } catch { return val; }
        }

        function formatMoney(prefix, amount, suffix){
            if (amount === undefined || amount === null || amount === '') return '';
            const num = Number(amount); if (isNaN(num)) return String(amount);
            return `${prefix || ''}${num.toFixed(2)}${suffix || ''}`;
        }

        function renderProducts(listEl, data){
            const products = Array.isArray(data?.cart_products) ? data.cart_products : [];
            if (!products.length){
                listEl.innerHTML = '<div class="card">购物车为空</div>';
                return;
            }

            const currency = (Array.isArray(data?.currency) ? data.currency[0] : null) || {};
            const prefix = currency.prefix || '';
            const suffix = currency.suffix || '';

            const frag = document.createDocumentFragment();
            products.forEach((p, i) => {
                const card = document.createElement('div');
                card.className = 'card';

                const unit = Number(p?.pricing || 0);
                const setup = Number(p?.setup_pricing || 0);
                const total = unit + setup;

                const conf = parseMaybeJson(p?.configoptions ?? '');
                const confText = typeof conf === 'object' ? JSON.stringify(conf, null, 2) : String(conf || '无');

                card.innerHTML = `
                    <div class="row"><span class="label">商品序号</span><span class="value mono">#${i+1}</span></div>
                    <div class="row"><span class="label">产品ID</span><span class="value mono">${p?.productid ?? ''}</span></div>
                    <div class="row"><span class="label">产品名</span><span class="value">${p?.productsname ?? ''}</span></div>
                    <div class="row"><span class="label">周期</span><span class="value">${p?.billingcycle_desc ?? p?.billingcycle ?? ''}</span></div>
                    <div class="row"><span class="label">单价</span><span class="value">${p?.pricing_show || formatMoney(prefix, unit, suffix)}</span></div>
                    <div class="row"><span class="label">安装费</span><span class="value">${p?.setup_pricing_show || formatMoney(prefix, setup, suffix)}</span></div>
                    <div class="row"><span class="label">商品总价</span><span class="value"><strong>${formatMoney(prefix, total, suffix)}</strong></span></div>
                    <div class="card-actions">
                        <button class="btn btn-danger" onclick="deleteCartItem(${i})">删除</button>
                    </div>
                `;

                frag.appendChild(card);
            });
            listEl.innerHTML = '';
            listEl.appendChild(frag);
        }

        function renderPromo(container, data){
            const promo = Array.isArray(data?.promo) ? data.promo : [];
            if (!promo.length) return;
            const p = promo[0];
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="row"><span class="label">优惠</span><span class="value">${p?.promo_desc_str || p?.promo_desc || ''}</span></div>
                <div class="row"><span class="label">抵扣</span><span class="value">${p?.promo_price_str || ''}</span></div>
            `;
            container.appendChild(card);
        }

		function renderSummary(summaryEl, data, hasItems){
            const subtotal = data?.subtotal || '';
            const totalSetup = data?.total_setup_pricing || '';
            const totalPricing = data?.total_pricing || '';
            const totalDesc = data?.total_desc || '';

            const rows = [];
            if (totalPricing) rows.push(`<div class="summary-row"><span>商品小计</span><span>${totalPricing}</span></div>`);
            if (totalSetup) rows.push(`<div class="summary-row"><span>安装小计</span><span>${totalSetup}</span></div>`);
            if (subtotal) rows.push(`<div class="summary-row"><span>总计小计</span><span>${subtotal}</span></div>`);
			if (totalDesc) rows.push(`<div class="summary-row total"><span>合计</span><span>${totalDesc}</span></div>`);
			rows.push(`<div class="checkout"><button class="checkout-btn" ${hasItems ? '' : 'disabled'} onclick="goCheckout()">去结算</button></div>`);
            summaryEl.innerHTML = rows.join('');
            summaryEl.style.display = 'block';
        }

		function goCheckout(){
			const btn = document.querySelector('.checkout-btn');
			if (btn && btn.disabled) return;
			window.location.href = 'https://app2.ceshi.cs/cart?action=viewcart';
		}

        async function loadCart(){
            const content = $('content');
            const summary = $('summary');
            $('statusBar').style.display = 'none';
            content.innerHTML = '<div class="loading"><div class="spinner"></div><span>加载中…</span></div>';

            try {
                const resp = await fetch(API_URL, { method: 'GET', credentials: 'include' });
                const raw = await resp.text();
                // 输出API原文到控制台
                console.log('[cart.get_shop_data raw]', raw);

                let result;
                try {
                    result = JSON.parse(raw);
                } catch (parseErr) {
                    showStatus('返回数据解析失败', 'error');
                    console.error('cart.parse.error', parseErr);
                    content.innerHTML = '<div class="card">返回数据解析失败，请稍后重试。</div>';
                    return;
                }

                switch(result?.status){
                    case 200: showStatus('购物车已加载', 'success'); break;
                    case 201: case 203: case 204: showStatus(result?.msg || '暂无更多信息', 'info'); break;
                    case 400: case 401: case 406: showStatus(result?.msg || '请求失败', 'error'); break;
                    default: showStatus(result?.msg || '未知状态', 'info');
                }

				const data = result?.data || {};
                content.innerHTML = '';
                renderProducts(content, data);
                renderPromo(content, data);
				const hasItems = Array.isArray(data?.cart_products) && data.cart_products.length > 0;
				renderSummary(summary, data, hasItems);
            } catch (e) {
                showStatus('加载失败：' + (e?.message || e), 'error');
                content.innerHTML = '<div class="card">无法加载购物车数据，请稍后重试。</div>';
            }
        }

        async function deleteCartItem(position){
            if (position == null || position < 0) return;
            try {
                const url = `https://app2.ceshi.cs/v1/cart/products/${position}`;
                const resp = await fetch(url, { method: 'DELETE', credentials: 'include' });
                const raw = await resp.text();
                console.log('[cart.delete raw]', raw);
                let result;
                try { result = JSON.parse(raw); } catch { result = { status: resp.status, msg: raw }; }

                if (result.status === 200) {
                    showStatus(result.msg || '删除成功', 'success');
                    await loadCart();
                } else {
                    showStatus(result.msg || '删除失败', 'error');
                }
            } catch (e) {
                showStatus('删除失败：' + (e?.message || e), 'error');
            }
        }

        document.addEventListener('visibilitychange', () => { if (!document.hidden) loadCart(); });
        document.addEventListener('DOMContentLoaded', loadCart);
    </script>
</head>
<body>
    <div class="cart-container">
        <div class="cart-header"><h1 class="cart-title">我的购物车</h1></div>
        <div id="statusBar" class="notice"></div>
        <div id="content" class="cart-content"></div>
        <div id="summary" class="summary" style="display:none"></div>
    </div>
</body>
</html>
